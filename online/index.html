<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script
  src="https://code.jquery.com/jquery-3.4.1.js"
  integrity="sha256-WpOohJOqMqqyKL9FccASB9O0KwACQJpFTUBLTYOVvVU="
  crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js"></script>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<link rel="stylesheet" href="style.css">

<div class="flexbox-container">
	<div id="playerTop" class="flexbox-item flexbox-item-1">Other Player1</div>
</div>
<div class="flexbox-container">
	<div id="playerRight"class="flexbox-item flexbox-item-2">Other Player2

	</div>
	<div id="dobottKartyak"class="flexbox-item flexbox-dobottKartyak">Dobott kártyák</div>
	<div id="playerLeft"class="flexbox-item flexbox-item-3">Other Player3</div>
</div>
<div class="flexbox-container">
	<div id="cards"class="flexbox-item flexbox-item-sajat">A kártyáid</div>
</div>
<div id="gamestats">Game Stats</div>



<div class="container">
	<div id="chatWindow" class="jumbotron">
		<h1 class="display-4">Chat panel</h1>
		<input id = "name" class="form-control" placeholder="Name">
		<br>
		<textarea id = "message" class="form-control" placeholder="Your Message Here">
	</textarea>
		<br>
		<button id="send" class="btn btn-success" onclick="sendMessage()">Send</button>
		<!-- <textarea id = "textAreatext" class="form-control" placeholder="Your Message Here"></textarea> -->
		</div>
		<div id="messages">
			<h3>Üzenetek</h3>
		
		</div>
</div>

<script type="text/javascript" src="main.js"></script>

<script>
var socket = io.connect('http://localhost:4200');
let domTarget;

// when client connects to server
// socket.on('connect', function(data) {
// 	let playerSocketID = socket.io.engine.id;
// 	console.log("socket id sent to server is: " + playerSocketID);
// 	socket.emit('join', playerSocketID);
// 	});

	// // notifies of connections
	// socket.on('connect', function() {
  	// 	if(socket.connected){
	// 		let text = "You are connected to the server.";
	// 		appendStats(text);
  	// 	} else {
	// 		let text = "Connection to server is lost.";
	// 		appendStats(text);
	// 	}
	// });

	
	// FROM HERE CAN SEND INDEX.HTML

	// listens to when all players joined and notify server
    socket.on('onePlayerJoined', function(counter) {
		console.log("Number of connections: " + counter);
		if(counter == 4){
			socket.emit('allPlayersJoined', "allPlayersJoined");
		}
	});
	
	// inform in browser console that all players joined
    socket.on('allPlayersJoined', function(msg) {
		console.log("Server says: " + msg);
		let text = msg;
		appendStats(text);
		socket.emit('letTheGameBegin', "letTheGameBegin");
	});	

	// receive notification from server that all has been set up
    socket.on('setupDone', function(data) {
		// data: players[] and clients[]

		// who is player who
		console.log("my socket is: " + socket.io.engine.id);
		let mySocket = socket.io.engine.id;
		for(i=0; i<4; i++){
			if(data.players[i].playerID == mySocket){
				console.log("my player id is: " + data.players[i].playerID);
				// add player id to DOM
				let text = "Hello, I'm player: " + data.players[i].playerID;
				appendStats(text);
				// add
				for(j=0; j<13; j++){
					let text = getColor(data.players[i].playerCards[j].color) + " " + getNumber(data.players[i].playerCards[j].number);
					appendStats(text, "cards");
				}
				console.log("my player cards are: " + data.players[i].playerCards);
			}
		}
		socket.emit('boardDrawn', "");
	});

	socket.on('firstplayer', (text) =>{
		appendStats(text);
	})
	socket.on('updateStats', (text) =>{
		appendStats(text);
	})
	socket.on('onCorrectPlayerPick', (text)=>{
		// check if we have 4 so new round can start clear
		let numberOfDobottKartyak = document.querySelectorAll(".dobottKartyak");
		if(numberOfDobottKartyak.length == 4){
			for(i=0; i<numberOfDobottKartyak.length; i++){
				numberOfDobottKartyak[i].remove();
			}
		}
		appendStats(text, "dobottKartyak");
	})
	socket.on('notYourTurn', (text)=>{
		alert(text);
	})
	socket.on('roundWinner', (winner)=>{
		text = "Player" + parseInt(winner+1) + " has won this round!";
		appendStats(text)
		text = "Player" + parseInt(winner+1) + "'s round.";
		appendStats(text)
	})
	socket.on('newRound', (text)=>{
		appendStats(text);
	})

	socket.on('messageReceived', (text)=>{
		appendStats(text, "messages");
	})
	
	socket.on('removeCardfromDom', ()=>{
		// e.target.remove();
		domTarget.remove();
	})

	socket.on('err', (message)=>{
		console.log("Már negvannak négyen!");
	})
	socket.on('gameOver', ()=>{
		text = "GAME OVER";
		appendStats(text);

		// create a score board

		// redirect to landing page

	})
	
// check if player's turn
document.onclick = function(e){
	domTarget = e.target;
	if(e.target.tagName == 'LI'){
		pickedCard = e.target.textContent.split(' ');
		let myID = socket.io.engine.id;
		let data = {
			myID : myID,
			pickedCard : pickedCard
		}
		socket.emit('playerPickedCard', data);
	}
}

socket.on('broad', function(data) {
	$('#future').append(data+ "<br/>");
});



$('form').submit(function(e){
e.preventDefault();
var message = $('#chat_input').val();
socket.emit('messages', message);
});

function appendStats (text, div="gamestats") {
	if(div=="dobottKartyak"){
		var li = document.createElement("li");
		li.className = "dobottKartyak"
		text = document.createTextNode(text);
		li.appendChild(text);
		var addToDiv = document.getElementById(div);
		addToDiv.appendChild(li);

	} else{
		var li = document.createElement("li");
		text = document.createTextNode(text);
		li.appendChild(text);
		var addToDiv = document.getElementById(div);
		addToDiv.appendChild(li);
	}
}

// name cards
function getColor(color){
	switch(color){
		case 0:
			return "Treff";
		case 1:
			return "Káró";
		case 2:
			return "Kőr";
		case 3:
			return "Pikk";
		default:
			console.log("fail");
	}
}

function getNumber(number){
	switch(number){
		case 0:
			return "2";
		case 1:
			return "3";
		case 2:
			return "4";
		case 3:
			return "5";
		case 4:
			return "6";
		case 5:
			return "7";
		case 6:
			return "8";
		case 7:
			return "9";
		case 8:
			return "10"
		case 9:
			return "Bubi";
		case 10:
			return "Dáma";
		case 11:
			return "Király";
		case 12:
			return "Ász"
		default:
			console.log("fail");
	}
}

// CHAT
function sendMessage(){
	let name = document.getElementById("name").value;
	let message = document.getElementById("message").value;
	text = name + " says: " + message;
	socket.emit('chatMessage', text);
	// reset content
	let m = document.getElementById("message");
	m.value = "";

}

// init

/*

// shuffle cards in deck array
shuffle(deck);
// split deck to 4 slices
splitDeck();
// create elements in DOM and name all Cards
drawBoard();
socket.emit('board', players);

// game specific variables
let round = 1;
let text;
let canCallQofSpades = false;
let canCallHeart = false
let playerOrder = new Array();
let evalCards = new Array();
let cardsToReceiveByPlayer = new Array();
let originalPlayerOrder = new Array();
// let isDone = false;
let winner;

// ==================================================================================
// game loop
function mainLoop() {
    update();
    // check if game ended
	if(deck.length == 0){
		console.log("GAME OVER!!!");
		return;
   		}
	requestAnimationFrame(mainLoop);
	}

// Start things off
requestAnimationFrame(mainLoop);
// ==================================================================================



// round update
function update(){
   	// check if update is needed
   	if (playerOrder.length == 0) {
	    getPlayOrder(winner);
	    // keep record with original one to determine winner
	    originalPlayerOrder.length = 0;
	    for(i=0; i<playerOrder.length; i++){
	    	originalPlayerOrder.push(playerOrder[i]);
	}
	// increment round
	incrementRound();
	}
}

function incrementRound(){
	return round += 1;
}

function getPlayOrder(winner){
	// define player order
	var firstPlayer;
	if(round == 1){
		firstPlayer = getPlayerOrder(0,0);
	} else {
		firstPlayer = winner;
	}
	playerOrder.push(firstPlayer);
	// add rest of players
	addRestPlayers(firstPlayer);
	text = round + " ROUND BEGINS!"
	appendStats(text);
	text = "Player" + (firstPlayer + 1) + " starts!"
	appendStats(text);
	// text = "PLAYER ORDER: " + playerOrder;
	// appendStats(text);
	// return isDone = true;
}



// check if player's turn
document.onclick = function(e){
	if(e.target.tagName == 'LI'){

	pickedCard = e.target.textContent.split(' ');
	// console.log("Player" + parseInt(playerOrder[0]+1) + " has picked " + pickedCard[0] + " " + pickedCard[1])


	// check if current player has the card to call
	var okPlayer = checkCard(getCardColor(pickedCard[0]), getCardNumber(pickedCard[1]));
	var currentPlayer = playerOrder[0];
	if(okPlayer == currentPlayer){
		text = "Player" + parseInt(playerOrder[0]+1) + " has picked " + pickedCard[0] + " " + pickedCard[1];
		appendStats(text);
		// remove player
		playerOrder.shift();
		// add card for eval
		evalCards.push({
			color: getCardColor(pickedCard[0]),
			number: getCardNumber(pickedCard[1])
			});
		// remove card
		removeCard(getCardColor(pickedCard[0]), getCardNumber(pickedCard[1]));
	  	e.target.remove();
	  	}
	  	else {
	  		text = "not this player's turn!";
	  		appendStats(text);
	  	}
   }
	console.log(evalCards);
		if(evalCards.length == 4){
			winner = evalRound(evalCards);
			// reset array
			evalCards.length = 0;
		}

}

function evalRound(evalCards){
	j = 0;
	for(i=1; i<4; i++){
		if(evalCards[j].color == evalCards[i].color){
			if(evalCards[j].number < evalCards[i].number)
				j = i;
		}
	}
	winner = originalPlayerOrder[j];
	text = "Winner is: Player" + parseInt(winner+1);
	appendStats(text);
	return winner;
}

function checkCard(color, number){
		// loop players and their cards
		var len = players.length;
		for(j=0;j<len;j++){
			for(i=0;i<players[j].playerCards.length;i++){
				// check if correct player had the card
				if(players[j].playerCards[i].color == color){
					if(players[j].playerCards[i].number == number){
						return players[j].playerNum;
					}
				}

			}

		}
}

// add rest players
function addRestPlayers(firstPlayer) {
	// case 3
	if(firstPlayer == 3){
		for(i=0; i<3; i++){
			playerOrder.push(i);
		}
		return playerOrder;	
	}

	// case 0
	else if(firstPlayer == 0) {
		for(i=firstPlayer + 1; i<players.length; i++){
			playerOrder.push(i);
		}
		return playerOrder;
	}
	// case 1, 2
	else {
		switch (firstPlayer) {
			case 1:
				return playerOrder = [1, 2, 3, 0];
			case 2:
				return playerOrder = [2, 3, 0, 1];
			default:
				console.log("fail in addRestPlayers");
		}
	}
}


// name cards
function getColor(color){
	switch(color){
		case 0:
			return "Treff";
		case 1:
			return "Káró";
		case 2:
			return "Kőr";
		case 3:
			return "Pikk";
		default:
			console.log("fail");
	}
}

function getNumber(number){
	switch(number){
		case 0:
			return "2";
		case 1:
			return "3";
		case 2:
			return "4";
		case 3:
			return "5";
		case 4:
			return "6";
		case 5:
			return "7";
		case 6:
			return "8";
		case 7:
			return "9";
		case 8:
			return "10"
		case 9:
			return "Bubi";
		case 10:
			return "Dáma";
		case 11:
			return "Király";
		case 12:
			return "Ász"
		default:
			console.log("fail");
	}
}

function shuffle(deck) {
  var currentIndex = deck.length, temporaryValue, randomIndex;

  // While there remain elements to shuffle...
  while (0 !== currentIndex) {

    // Pick a remaining element...
    randomIndex = Math.floor(Math.random() * currentIndex);
    currentIndex -= 1;

    // And swap it with the current element.
    temporaryValue = deck[currentIndex];
    deck[currentIndex] = deck[randomIndex];
    deck[randomIndex] = temporaryValue;
  }

  return deck;
}


function sortByColor(temparray) {
    let len = temparray.length-1;
    for (let i = 0; i < len; i++) {
        for (let j = 0; j < len; j++) {
            if (temparray[j].color > temparray[j + 1].color) {
                let tmp = temparray[j];
                temparray[j] = temparray[j + 1];
                temparray[j + 1] = tmp;
            }
        }
    }
    return temparray;
};

function getCardColor(color){
		switch (color){
			case "Treff":
				return 0;
			case "Káró":
				return 1;
			case "Kőr":
				return 2;
			case "Pikk":
				return 3;
			default:
				console.log("fail");
		}
	}



	function removeCard(color, number){
		// loop players and their cards
		var len = players.length;
		for(j=0;j<len;j++){
			for(i=0;i<players[j].playerCards.length;i++){
				// remove card from players card list
				if(players[j].playerCards[i].color == color){
					if(players[j].playerCards[i].number == number){
						players[j].playerCards.splice(i, 1);
						// also remove from deck
						deck.splice(i, 1);
					}
				}

			}

		}
	}

function getPlayerOrder(color, number){
		var len = players.length;
		for(j=0;j<len;j++){
			for(i=0;i<players[j].playerCards.length;i++){
				// return player[i]
				if(players[j].playerCards[i].color == color){
					if(players[j].playerCards[i].number == number){
						return players[j].playerNum;
					}
				}

			}

		}
}



function drawBoard(){
	var id = 0;
	for(j=0;j<players.length;j++){
		id++;
		for(i=0;i<players[j].playerCards.length;i++){
			var li = document.createElement("li");

			var text = document.createTextNode(getColor(players[j].playerCards[i].color) + " " + getNumber(players[j].playerCards[i].number));

			li.appendChild(text);

			var addToDiv = document.getElementById("div" + id);
			addToDiv.appendChild(li);
		}
	}

}

function createCards(){
	for(i=0; i<4; i++){
		// create colors
		for(j=0; j<13; j++){
			// create 13 numbers
			deck.push(new Card(i,j));
		}
	}
}

function createPlayers(){
	for(i=0; i<4;i++){
		players.push(new Player(i));
	}
}

function appendStats (text) {
	var li = document.createElement("li");
	text = document.createTextNode(text);
	li.appendChild(text);
	var addToDiv = document.getElementById("gamestats");
	addToDiv.appendChild(li);
}
*/
 


</script>